<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Jason Madi</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@15.0.0"></script>
</head>
<body>
    <div class="cursor"></div>
    <div class="cursor-follower"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">JM</a>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Retour √† l'accueil</a>
            </div>
        </div>
    </nav>

    <!-- Admin Login Section -->
    <section class="hero" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div class="container">
            <div class="admin-login-container" style="max-width: 500px; margin: 0 auto; text-align: center;">
                <!-- Login Form -->
                <div id="loginForm" class="admin-form">
                    <div class="section-header" style="margin-bottom: 2rem;">
                        <h2 class="section-title">Administration</h2>
                        <div class="section-line"></div>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 1.1rem;">Connectez-vous pour acc√©der au panneau d'administration</p>
                    </div>

                    <div class="code-block" style="margin-bottom: 2rem; text-align: left;">
                        <div class="code-header">
                            <div class="dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <span class="code-title">admin.login()</span>
                        </div>
                        <div class="code-content" style="padding: 2rem;">
                            <form id="adminLoginForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                                <div class="form-group">
                                    <label for="email" style="display: block; margin-bottom: 0.5rem; color: var(--accent); font-weight: 500;">Email :</label>
                                    <input 
                                        type="email" 
                                        id="email" 
                                        name="email" 
                                        required 
                                        style="width: 100%; padding: 0.8rem 1rem; border: 2px solid var(--card-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease;"
                                        placeholder="admin@example.com"
                                    >
                                </div>
                                <div class="form-group">
                                    <label for="password" style="display: block; margin-bottom: 0.5rem; color: var(--accent); font-weight: 500;">Mot de passe :</label>
                                    <input 
                                        type="password" 
                                        id="password" 
                                        name="password" 
                                        required 
                                        style="width: 100%; padding: 0.8rem 1rem; border: 2px solid var(--card-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease;"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    >
                                </div>
                                <button 
                                    type="submit" 
                                    class="btn btn-primary" 
                                    style="width: 100%; margin-top: 1rem; padding: 1rem;"
                                    id="loginBtn"
                                >
                                    <span id="loginBtnText">Se connecter</span>
                                    <div id="loginSpinner" style="display: none; width: 20px; height: 20px; border: 2px solid transparent; border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div id="errorMessage" class="error-message" style="display: none; padding: 1rem; background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; color: #ff6b6b; margin-top: 1rem;"></div>
                </div>

                <!-- Dashboard (Hidden initially) -->
                <div id="dashboard" class="admin-dashboard" style="display: none;">
                    <div class="section-header" style="margin-bottom: 2rem;">
                        <h2 class="section-title">Tableau de bord</h2>
                        <div class="section-line"></div>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 1.1rem;">Bienvenue dans votre espace d'administration</p>
                    </div>

                    <div class="admin-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="admin-card enhanced-contrast" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 1.5rem; transition: transform 0.3s ease;">
                            <h3 style="color: var(--accent); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                <span>üìä</span> Statistiques
                            </h3>
                            <div class="stat-grid" style="display: flex; flex-direction: column; gap: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-primary); font-weight: 500;">Visiteurs aujourd'hui :</span>
                                    <strong style="color: var(--accent); font-size: 1.1em;">42</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-primary); font-weight: 500;">Visiteurs total :</span>
                                    <strong style="color: var(--accent); font-size: 1.1em;">1,337</strong>
                                </div>
                            </div>
                        </div>

                        <div class="admin-card enhanced-contrast" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 1.5rem; transition: transform 0.3s ease;">
                            <h3 style="color: var(--accent); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                <span>‚öôÔ∏è</span> Actions rapides
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                                <button class="btn btn-outline" style="padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 500;">√âditer le profil</button>
                                <button class="btn btn-outline" style="padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 500;">G√©rer les projets</button>
                                <button id="editPhoneBtn" class="btn btn-outline" style="padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 500; border-color: var(--accent); color: var(--accent);">Modifier t√©l√©phone</button>
                            </div>
                        </div>

                        <div class="admin-card enhanced-contrast" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 1.5rem; transition: transform 0.3s ease;">
                            <h3 style="color: var(--accent); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                <span>üë§</span> Utilisateur connect√©
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-primary); font-weight: 500;">Email :</span>
                                    <strong id="userEmail" style="color: var(--accent); font-size: 0.9em; word-break: break-all;">-</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-primary); font-weight: 500;">T√©l√©phone :</span>
                                    <strong id="userPhone" style="color: var(--accent); font-size: 0.9em;">Non d√©fini</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-primary); font-weight: 500;">R√¥le :</span>
                                    <strong style="color: var(--accent); font-size: 0.9em;">Administrateur</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal pour modifier le t√©l√©phone -->
                    <div id="phoneModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; backdrop-filter: blur(5px);">
                        <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%;">
                            <div class="modal-header" style="margin-bottom: 1.5rem;">
                                <h3 style="color: var(--accent); margin: 0; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                    <span>üìû</span> Modifier le num√©ro de t√©l√©phone
                                </h3>
                            </div>
                            <form id="phoneForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                                <div class="form-group">
                                    <label for="phoneInput" style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">Num√©ro de t√©l√©phone :</label>
                                    <input 
                                        type="tel" 
                                        id="phoneInput" 
                                        name="phone" 
                                        style="width: 100%; padding: 0.8rem 1rem; border: 2px solid var(--card-border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease;"
                                        placeholder="+32 123 45 67 89"
                                    >
                                </div>
                                <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button type="button" id="cancelPhoneBtn" class="btn btn-outline" style="padding: 0.8rem 1.5rem; border-color: #ff6b6b; color: #ff6b6b;">Annuler</button>
                                    <button type="submit" id="savePhoneBtn" class="btn btn-primary" style="padding: 0.8rem 1.5rem;">
                                        <span id="savePhoneBtnText">Enregistrer</span>
                                        <div id="savePhoneSpinner" style="display: none; width: 16px; height: 16px; border: 2px solid transparent; border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="admin-actions" style="text-align: center;">
                        <button 
                            id="logoutBtn" 
                            class="btn btn-outline" 
                            style="padding: 0.8rem 2rem; border-color: #ff6b6b; color: #ff6b6b; font-weight: 500;"
                        >
                            Se d√©connecter
                        </button>
                    </div>

                    <!-- Messages de success/erreur -->
                    <div id="successMessage" class="success-message" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; color: #4caf50; text-align: center;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- AppWrite Configuration and Scripts -->
    <script>
        // Configuration AppWrite
        const { Client, Account } = Appwrite;
        
        const client = new Client()
            .setEndpoint('https://cloud.appwrite.io/v1')
            .setProject('68a1fc1500311f33db92');
        
        const account = new Account(client);

        // Variables globales
        let currentUser = null;

        // √âl√©ments DOM
        const loginForm = document.getElementById('loginForm');
        const dashboard = document.getElementById('dashboard');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginSpinner = document.getElementById('loginSpinner');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmail = document.getElementById('userEmail');
        const userPhone = document.getElementById('userPhone');
        
        // √âl√©ments du modal t√©l√©phone
        const editPhoneBtn = document.getElementById('editPhoneBtn');
        const phoneModal = document.getElementById('phoneModal');
        const phoneForm = document.getElementById('phoneForm');
        const phoneInput = document.getElementById('phoneInput');
        const cancelPhoneBtn = document.getElementById('cancelPhoneBtn');
        const savePhoneBtn = document.getElementById('savePhoneBtn');
        const savePhoneBtnText = document.getElementById('savePhoneBtnText');
        const savePhoneSpinner = document.getElementById('savePhoneSpinner');

        // Fonction pour afficher/masquer le spinner de chargement
        function toggleLoading(isLoading, btn = loginBtn, btnText = loginBtnText, spinner = loginSpinner) {
            if (isLoading) {
                btnText.style.display = 'none';
                spinner.style.display = 'block';
                btn.disabled = true;
            } else {
                btnText.style.display = 'block';
                spinner.style.display = 'none';
                btn.disabled = false;
            }
        }

        // Fonction pour afficher les erreurs
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Fonction pour afficher les messages de succ√®s
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        // Fonction pour afficher le dashboard
        function showDashboard(user) {
            currentUser = user;
            userEmail.textContent = user.email;
            userPhone.textContent = user.phone || 'Non d√©fini';
            loginForm.style.display = 'none';
            dashboard.style.display = 'block';
        }

        // Fonction pour afficher le formulaire de connexion
        function showLoginForm() {
            currentUser = null;
            loginForm.style.display = 'block';
            dashboard.style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // Fonction pour ouvrir le modal de t√©l√©phone
        function openPhoneModal() {
            phoneInput.value = currentUser.phone || '';
            phoneModal.style.display = 'block';
            phoneInput.focus();
        }

        // Fonction pour fermer le modal de t√©l√©phone
        function closePhoneModal() {
            phoneModal.style.display = 'none';
            phoneInput.value = '';
        }

        // Gestion de la soumission du formulaire de connexion
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            toggleLoading(true);
            errorMessage.style.display = 'none';

            try {
                // Tentative de connexion avec AppWrite
                const session = await account.createEmailPasswordSession(email, password);
                
                // R√©cup√©ration des informations utilisateur
                const user = await account.get();
                
                console.log('Connexion r√©ussie:', user);
                showDashboard(user);
                
            } catch (error) {
                console.error('Erreur de connexion:', error);
                
                let errorMsg = 'Erreur de connexion. Veuillez v√©rifier vos identifiants.';
                
                if (error.code === 401) {
                    errorMsg = 'Email ou mot de passe incorrect.';
                } else if (error.code === 429) {
                    errorMsg = 'Trop de tentatives. Veuillez r√©essayer plus tard.';
                } else if (error.code === 400) {
                    errorMsg = 'Donn√©es invalides. Veuillez v√©rifier vos informations.';
                }
                
                showError(errorMsg);
            } finally {
                toggleLoading(false);
            }
        });

        // Gestion de la modification du t√©l√©phone
        phoneForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const phone = phoneInput.value.trim();
            
            toggleLoading(true, savePhoneBtn, savePhoneBtnText, savePhoneSpinner);
            
            try {
                // Mise √† jour du num√©ro de t√©l√©phone avec AppWrite
                await account.updatePhone(phone, 'password_placeholder'); // AppWrite n√©cessite un mot de passe
                
                // Alternativement, on peut utiliser updatePrefs pour stocker dans les pr√©f√©rences
                await account.updatePrefs({ phone: phone });
                
                // Mise √† jour de l'utilisateur courant
                currentUser.phone = phone;
                userPhone.textContent = phone || 'Non d√©fini';
                
                showSuccess('‚úì Num√©ro de t√©l√©phone mis √† jour avec succ√®s !');
                closePhoneModal();
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du t√©l√©phone:', error);
                
                // Si la m√©thode updatePhone ne fonctionne pas, on utilise les pr√©f√©rences
                try {
                    await account.updatePrefs({ phone: phone });
                    currentUser.phone = phone;
                    userPhone.textContent = phone || 'Non d√©fini';
                    showSuccess('‚úì Num√©ro de t√©l√©phone mis √† jour avec succ√®s !');
                    closePhoneModal();
                } catch (prefsError) {
                    console.error('Erreur lors de la mise √† jour des pr√©f√©rences:', prefsError);
                    showError('Erreur lors de la mise √† jour du num√©ro de t√©l√©phone.');
                }
            } finally {
                toggleLoading(false, savePhoneBtn, savePhoneBtnText, savePhoneSpinner);
            }
        });

        // Gestion des √©v√©nements du modal t√©l√©phone
        editPhoneBtn.addEventListener('click', openPhoneModal);
        cancelPhoneBtn.addEventListener('click', closePhoneModal);
        
        // Fermer le modal en cliquant en dehors
        phoneModal.addEventListener('click', (e) => {
            if (e.target === phoneModal) {
                closePhoneModal();
            }
        });

        // Gestion de la d√©connexion
        logoutBtn.addEventListener('click', async () => {
            try {
                await account.deleteSession('current');
                console.log('D√©connexion r√©ussie');
                showLoginForm();
            } catch (error) {
                console.error('Erreur lors de la d√©connexion:', error);
                // On affiche quand m√™me le formulaire de connexion
                showLoginForm();
            }
        });

        // V√©rification de la session au chargement de la page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const user = await account.get();
                console.log('Session existante trouv√©e:', user);
                
                // R√©cup√©rer les pr√©f√©rences pour le t√©l√©phone
                try {
                    const prefs = await account.getPrefs();
                    if (prefs.phone) {
                        user.phone = prefs.phone;
                    }
                } catch (prefsError) {
                    console.log('Pas de pr√©f√©rences t√©l√©phone trouv√©es');
                }
                
                showDashboard(user);
            } catch (error) {
                console.log('Aucune session active, affichage du formulaire de connexion');
                showLoginForm();
            }
        });

        // Animation du focus sur les champs de saisie
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.style.borderColor = 'var(--accent)';
                this.style.boxShadow = '0 0 0 3px rgba(74, 144, 226, 0.1)';
            });
            
            input.addEventListener('blur', function() {
                this.style.borderColor = 'var(--card-border)';
                this.style.boxShadow = 'none';
            });
        });

        // Animation des cartes admin au survol
        const adminCards = document.querySelectorAll('.admin-card');
        adminCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            });
        });
    </script>

    <!-- Animation CSS pour le spinner -->
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Am√©lioration du contraste sur les cartes */
        .enhanced-contrast {
            background: var(--card-bg) !important;
            border: 1px solid var(--card-border) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .enhanced-contrast span, 
        .enhanced-contrast strong {
            font-weight: 600;
        }

        .admin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
        }

        input:focus {
            outline: none;
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1) !important;
        }

        .error-message {
            animation: slideIn 0.3s ease-out;
        }

        .success-message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .admin-grid {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Styles pour le modal */
        .modal {
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            animation: slideInModal 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInModal {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Responsive pour les cartes */
        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr !important;
            }
            
            .modal-content {
                width: 95% !important;
                padding: 1.5rem !important;
            }
        }
    </style>

    <!-- Script du curseur (r√©utilis√© depuis l'index) -->
    <script src="script.js"></script>
</body>
</html>